<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Class: NoSE::Search::Search
  
    &mdash; Documentation by YARD 0.9.24
  
</title>

  <link rel="stylesheet" href="../../css/style.css" type="text/css" />

  <link rel="stylesheet" href="../../css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "NoSE::Search::Search";
  relpath = '../../';
</script>


  <script type="text/javascript" charset="utf-8" src="../../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../../js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="../../class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="../../_index.html">Index (S)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../../NoSE.html" title="NoSE (module)">NoSE</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../Search.html" title="NoSE::Search (module)">Search</a></span></span>
     &raquo; 
    <span class="title">Search</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../../class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><h1>Class: NoSE::Search::Search
  
  
  
</h1>
<div class="box_info">
  
  <dl>
    <dt>Inherits:</dt>
    <dd>
      <span class="inheritName"><span class='object_link'><a href="../../Object.html" title="Object (class)">Object</a></span></span>
      
        <ul class="fullTree">
          <li><span class='object_link'><a href="../../Object.html" title="Object (class)">Object</a></span></li>
          
            <li class="next">NoSE::Search::Search</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
    </dd>
  </dl>
  

  
  
  
  
  

  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>lib/nose/search.rb</dd>
  </dl>
  
</div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>Searches for the optimal indices for a given workload</p>


  </div>
</div>
<div class="tags">
  

</div>






  
    <h2>
      Instance Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#combine_query_weights-instance_method" title="#combine_query_weights (instance method)">#<strong>combine_query_weights</strong>(indexes)  &#x21d2; void </a>
    

    
  </span>
  
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Combine the weights of queries and statements.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#initialize-instance_method" title="#initialize (instance method)">#<strong>initialize</strong>(workload, cost_model, objective = Objective::COST, by_id_graph = false)  &#x21d2; Search </a>
    

    
  </span>
  
  
    <span class="note title constructor">constructor</span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>A new instance of Search.</p>
</div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#log_search_start-instance_method" title="#log_search_start (instance method)">#<strong>log_search_start</strong>(costs, query_weights)  &#x21d2; void </a>
    

    
  </span>
  
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Produce a useful log message before starting the search.</p>
</div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#populate_query_costs-instance_method" title="#populate_query_costs (instance method)">#<strong>populate_query_costs</strong>(query_costs, steps_by_index, weight, query, tree)  &#x21d2; void </a>
    

    
  </span>
  
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Store the costs and indexes for this plan in a nested hash.</p>
</div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#populate_update_costs-instance_method" title="#populate_update_costs (instance method)">#<strong>populate_update_costs</strong>(planner, statement, indexes, update_costs, update_plans)  &#x21d2; void </a>
    

    
  </span>
  
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Populate the cost of all necessary plans for the given satement.</p>
</div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#query_cost-instance_method" title="#query_cost (instance method)">#<strong>query_cost</strong>(planner, query, weight)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Get the cost for indices for an individual query.</p>
</div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#query_costs-instance_method" title="#query_costs (instance method)">#<strong>query_costs</strong>(query_weights, indexes)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Get the cost of using each index for each query in a workload.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#search_overlap-instance_method" title="#search_overlap (instance method)">#<strong>search_overlap</strong>(indexes, max_space = Float::INFINITY)  &#x21d2; Results </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Search for optimal indices using an ILP which searches for non-overlapping indices.</p>
</div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#search_result-instance_method" title="#search_result (instance method)">#<strong>search_result</strong>(query_weights, indexes, solver_params, trees, update_plans)  &#x21d2; Results </a>
    

    
  </span>
  
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Run the solver and get the results of search.</p>
</div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#select_plans-instance_method" title="#select_plans (instance method)">#<strong>select_plans</strong>(trees, indexes)  &#x21d2; Array&lt;Plans::QueryPlan&gt; </a>
    

    
  </span>
  
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Select the plans to use for a given set of indexes.</p>
</div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#solve_mipper-instance_method" title="#solve_mipper (instance method)">#<strong>solve_mipper</strong>(queries, indexes, data)  &#x21d2; Results </a>
    

    
  </span>
  
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Solve the index selection problem using MIPPeR.</p>
</div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#update_costs-instance_method" title="#update_costs (instance method)">#<strong>update_costs</strong>(trees, indexes)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Produce the cost of updates in the workload.</p>
</div></span>
  
</li>

      
    </ul>
  

<div id="constructor_details" class="method_details_list">
  <h2>Constructor Details</h2>
  
    <div class="method_details first">
  <h3 class="signature first" id="initialize-instance_method">
  
    #<strong>initialize</strong>(workload, cost_model, objective = Objective::COST, by_id_graph = false)  &#x21d2; <tt><span class='object_link'><a href="" title="NoSE::Search::Search (class)">Search</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns a new instance of Search.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


16
17
18
19
20
21
22
23
24
25
26
27
28</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/nose/search.rb', line 16</span>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='id identifier rubyid_workload'>workload</span><span class='comma'>,</span> <span class='id identifier rubyid_cost_model'>cost_model</span><span class='comma'>,</span> <span class='id identifier rubyid_objective'>objective</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Objective.html" title="NoSE::Search::Objective (module)">Objective</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Objective.html#COST-constant" title="NoSE::Search::Objective::COST (constant)">COST</a></span></span><span class='comma'>,</span>
               <span class='id identifier rubyid_by_id_graph'>by_id_graph</span> <span class='op'>=</span> <span class='kw'>false</span><span class='rparen'>)</span>
  <span class='ivar'>@logger</span> <span class='op'>=</span> <span class='const'>Logging</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>nose::search</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
  <span class='ivar'>@workload</span> <span class='op'>=</span> <span class='id identifier rubyid_workload'>workload</span>
  <span class='ivar'>@cost_model</span> <span class='op'>=</span> <span class='id identifier rubyid_cost_model'>cost_model</span>
  <span class='ivar'>@objective</span> <span class='op'>=</span> <span class='id identifier rubyid_objective'>objective</span>
  <span class='ivar'>@by_id_graph</span> <span class='op'>=</span> <span class='id identifier rubyid_by_id_graph'>by_id_graph</span>

  <span class='comment'># For now we only support optimization based on cost when grouping by
</span>  <span class='comment'># ID graphs, but support for other objectives is still feasible
</span>  <span class='id identifier rubyid_fail'>fail</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Only cost-based optimization allowed when using ID graphs</span><span class='tstring_end'>&#39;</span></span> \
    <span class='kw'>if</span> <span class='ivar'>@by_id_graph</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_objective'>objective</span> <span class='op'>!=</span> <span class='const'><span class='object_link'><a href="Objective.html" title="NoSE::Search::Objective (module)">Objective</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Objective.html#COST-constant" title="NoSE::Search::Objective::COST (constant)">COST</a></span></span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
  
</div>


  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="combine_query_weights-instance_method">
  
    #<strong>combine_query_weights</strong>(indexes)  &#x21d2; <tt>void</tt>  <span class="extras">(private)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p>
<p>Combine the weights of queries and statements</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


58
59
60
61
62
63
64
65
66
67
68</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/nose/search.rb', line 58</span>

<span class='kw'>def</span> <span class='id identifier rubyid_combine_query_weights'>combine_query_weights</span><span class='lparen'>(</span><span class='id identifier rubyid_indexes'>indexes</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_indexes'>indexes</span> <span class='op'>=</span> <span class='id identifier rubyid_indexes'>indexes</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:to_id_graph</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_uniq'>uniq</span> <span class='kw'>if</span> <span class='ivar'>@by_id_graph</span>
  <span class='id identifier rubyid_query_weights'>query_weights</span> <span class='op'>=</span> <span class='const'>Hash</span><span class='lbracket'>[</span><span class='ivar'>@workload</span><span class='period'>.</span><span class='id identifier rubyid_support_queries'>support_queries</span><span class='lparen'>(</span><span class='id identifier rubyid_indexes'>indexes</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_query'>query</span><span class='op'>|</span>
    <span class='lbracket'>[</span><span class='id identifier rubyid_query'>query</span><span class='comma'>,</span> <span class='ivar'>@workload</span><span class='period'>.</span><span class='id identifier rubyid_statement_weights'>statement_weights</span><span class='lbracket'>[</span><span class='id identifier rubyid_query'>query</span><span class='period'>.</span><span class='id identifier rubyid_statement'>statement</span><span class='rbracket'>]</span><span class='rbracket'>]</span>
  <span class='kw'>end</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_query_weights'>query_weights</span><span class='period'>.</span><span class='id identifier rubyid_merge!'>merge!</span><span class='lparen'>(</span><span class='ivar'>@workload</span><span class='period'>.</span><span class='id identifier rubyid_statement_weights'>statement_weights</span><span class='period'>.</span><span class='id identifier rubyid_select'>select</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_stmt'>stmt</span><span class='comma'>,</span> <span class='id identifier rubyid__'>_</span><span class='op'>|</span>
    <span class='id identifier rubyid_stmt'>stmt</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span> <span class='const'><span class='object_link'><a href="../Query.html" title="NoSE::Query (class)">Query</a></span></span>
  <span class='kw'>end</span><span class='period'>.</span><span class='id identifier rubyid_to_h'>to_h</span><span class='rparen'>)</span>

  <span class='id identifier rubyid_query_weights'>query_weights</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="log_search_start-instance_method">
  
    #<strong>log_search_start</strong>(costs, query_weights)  &#x21d2; <tt>void</tt>  <span class="extras">(private)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p>
<p>Produce a useful log message before starting the search</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


72
73
74
75
76
77
78
79
80</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/nose/search.rb', line 72</span>

<span class='kw'>def</span> <span class='id identifier rubyid_log_search_start'>log_search_start</span><span class='lparen'>(</span><span class='id identifier rubyid_costs'>costs</span><span class='comma'>,</span> <span class='id identifier rubyid_query_weights'>query_weights</span><span class='rparen'>)</span>
  <span class='ivar'>@logger</span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span> <span class='kw'>do</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Costs: \n</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='id identifier rubyid_pp_s'>pp_s</span><span class='lparen'>(</span><span class='id identifier rubyid_costs'>costs</span><span class='rparen'>)</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span> \
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Search with queries:\n</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> \
      <span class='id identifier rubyid_query_weights'>query_weights</span><span class='period'>.</span><span class='id identifier rubyid_each_key'>each_key</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='period'>.</span><span class='id identifier rubyid_with_index'>with_index</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_query'>query</span><span class='comma'>,</span> <span class='id identifier rubyid_i'>i</span><span class='op'>|</span>
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_i'>i</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_query'>query</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>end</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="populate_query_costs-instance_method">
  
    #<strong>populate_query_costs</strong>(query_costs, steps_by_index, weight, query, tree)  &#x21d2; <tt>void</tt>  <span class="extras">(private)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p>
<p>Store the costs and indexes for this plan in a nested hash</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/nose/search.rb', line 207</span>

<span class='kw'>def</span> <span class='id identifier rubyid_populate_query_costs'>populate_query_costs</span><span class='lparen'>(</span><span class='id identifier rubyid_query_costs'>query_costs</span><span class='comma'>,</span> <span class='id identifier rubyid_steps_by_index'>steps_by_index</span><span class='comma'>,</span> <span class='id identifier rubyid_weight'>weight</span><span class='comma'>,</span>
                         <span class='id identifier rubyid_query'>query</span><span class='comma'>,</span> <span class='id identifier rubyid_tree'>tree</span><span class='rparen'>)</span>
  <span class='comment'># The first key is the query and the second is the index
</span>  <span class='comment'>#
</span>  <span class='comment'># The value is a two-element array with the indices which are
</span>  <span class='comment'># jointly used to answer a step in the query plan along with
</span>  <span class='comment'># the cost of all plan steps for the part of the query graph
</span>  <span class='id identifier rubyid_steps_by_index'>steps_by_index</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_steps'>steps</span><span class='op'>|</span>
    <span class='comment'># Get the indexes for these plan steps
</span>    <span class='id identifier rubyid_index_step'>index_step</span> <span class='op'>=</span> <span class='id identifier rubyid_steps'>steps</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>

    <span class='comment'># Calculate the cost for just these steps in the plan
</span>    <span class='id identifier rubyid_cost'>cost</span> <span class='op'>=</span> <span class='id identifier rubyid_steps'>steps</span><span class='period'>.</span><span class='id identifier rubyid_sum_by'>sum_by</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:cost</span><span class='rparen'>)</span> <span class='op'>*</span> <span class='id identifier rubyid_weight'>weight</span>

    <span class='comment'># Don&#39;t count the cost for sorting at the end
</span>    <span class='id identifier rubyid_sort_step'>sort_step</span> <span class='op'>=</span> <span class='id identifier rubyid_steps'>steps</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_s'>s</span><span class='op'>|</span> <span class='id identifier rubyid_s'>s</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span> <span class='const'><span class='object_link'><a href="../Plans.html" title="NoSE::Plans (module)">Plans</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Plans/SortPlanStep.html" title="NoSE::Plans::SortPlanStep (class)">SortPlanStep</a></span></span> <span class='rbrace'>}</span>
    <span class='id identifier rubyid_cost'>cost</span> <span class='op'>-=</span> <span class='id identifier rubyid_sort_step'>sort_step</span><span class='period'>.</span><span class='id identifier rubyid_cost'>cost</span> <span class='op'>*</span> <span class='id identifier rubyid_weight'>weight</span> <span class='kw'>unless</span> <span class='id identifier rubyid_sort_step'>sort_step</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>

    <span class='kw'>if</span> <span class='id identifier rubyid_query_costs'>query_costs</span><span class='period'>.</span><span class='id identifier rubyid_key?'>key?</span> <span class='id identifier rubyid_index_step'>index_step</span><span class='period'>.</span><span class='id identifier rubyid_index'>index</span>
      <span class='id identifier rubyid_current_cost'>current_cost</span> <span class='op'>=</span> <span class='id identifier rubyid_query_costs'>query_costs</span><span class='lbracket'>[</span><span class='id identifier rubyid_index_step'>index_step</span><span class='period'>.</span><span class='id identifier rubyid_index'>index</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_last'>last</span>

      <span class='comment'># We must always have the same cost
</span>      <span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_current_cost'>current_cost</span> <span class='op'>-</span> <span class='id identifier rubyid_cost'>cost</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_abs'>abs</span> <span class='op'>&gt;=</span> <span class='float'>10E-6</span>
        <span class='id identifier rubyid_index'>index</span> <span class='op'>=</span> <span class='id identifier rubyid_index_step'>index_step</span><span class='period'>.</span><span class='id identifier rubyid_index'>index</span>
        <span class='id identifier rubyid_p'>p</span> <span class='id identifier rubyid_query'>query</span>
        <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Index </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_index'>index</span><span class='period'>.</span><span class='id identifier rubyid_key'>key</span><span class='embexpr_end'>}</span><span class='tstring_content'> does not have equivalent cost</span><span class='tstring_end'>&quot;</span></span>
        <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Current cost: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_current_cost'>current_cost</span><span class='embexpr_end'>}</span><span class='tstring_content'>, discovered cost: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_cost'>cost</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>

        <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\nCurrent steps</span><span class='tstring_end'>&quot;</span></span>
        <span class='id identifier rubyid_query_costs'>query_costs</span><span class='lbracket'>[</span><span class='id identifier rubyid_index_step'>index_step</span><span class='period'>.</span><span class='id identifier rubyid_index'>index</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_s'>s</span><span class='op'>|</span> <span class='id identifier rubyid_p'>p</span> <span class='id identifier rubyid_s'>s</span> <span class='rbrace'>}</span>

        <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\nDiscovered steps</span><span class='tstring_end'>&quot;</span></span>
        <span class='id identifier rubyid_steps'>steps</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_s'>s</span><span class='op'>|</span> <span class='id identifier rubyid_p'>p</span> <span class='id identifier rubyid_s'>s</span> <span class='rbrace'>}</span>
        <span class='id identifier rubyid_puts'>puts</span>

        <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>=======================================</span><span class='tstring_end'>&#39;</span></span>
        <span class='id identifier rubyid_tree'>tree</span><span class='period'>.</span><span class='id identifier rubyid_sort_by'>sort_by</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:cost</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_plan'>plan</span><span class='op'>|</span>
          <span class='kw'>next</span> <span class='kw'>unless</span> <span class='id identifier rubyid_plan'>plan</span><span class='period'>.</span><span class='id identifier rubyid_indexes'>indexes</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='id identifier rubyid_index_step'>index_step</span><span class='period'>.</span><span class='id identifier rubyid_index'>index</span><span class='rparen'>)</span>
          <span class='id identifier rubyid_plan'>plan</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_step'>step</span><span class='op'>|</span>
            <span class='id identifier rubyid_print'>print</span><span class='lparen'>(</span><span class='id identifier rubyid_format'>format</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>%.3f</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_step'>step</span><span class='period'>.</span><span class='id identifier rubyid_cost'>cost</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_rjust'>rjust</span><span class='lparen'>(</span><span class='int'>7</span><span class='rparen'>)</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'> </span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
            <span class='id identifier rubyid_p'>p</span> <span class='id identifier rubyid_step'>step</span>
          <span class='kw'>end</span>
          <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_format'>format</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>%.3f</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_plan'>plan</span><span class='period'>.</span><span class='id identifier rubyid_cost'>cost</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_rjust'>rjust</span><span class='lparen'>(</span><span class='int'>7</span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'> total</span><span class='tstring_end'>&quot;</span></span>
          <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>=======================================</span><span class='tstring_end'>&#39;</span></span>
        <span class='kw'>end</span>

        <span class='id identifier rubyid_puts'>puts</span>
        <span class='id identifier rubyid_p'>p</span> <span class='id identifier rubyid_tree'>tree</span>

        <span class='id identifier rubyid_fail'>fail</span>
      <span class='kw'>end</span>
    <span class='kw'>else</span>
      <span class='comment'># We either found a new plan or something cheaper
</span>      <span class='id identifier rubyid_query_costs'>query_costs</span><span class='lbracket'>[</span><span class='id identifier rubyid_index_step'>index_step</span><span class='period'>.</span><span class='id identifier rubyid_index'>index</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_steps'>steps</span><span class='comma'>,</span> <span class='id identifier rubyid_cost'>cost</span><span class='rbracket'>]</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="populate_update_costs-instance_method">
  
    #<strong>populate_update_costs</strong>(planner, statement, indexes, update_costs, update_plans)  &#x21d2; <tt>void</tt>  <span class="extras">(private)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p>
<p>Populate the cost of all necessary plans for the given satement</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


161
162
163
164
165
166
167
168</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/nose/search.rb', line 161</span>

<span class='kw'>def</span> <span class='id identifier rubyid_populate_update_costs'>populate_update_costs</span><span class='lparen'>(</span><span class='id identifier rubyid_planner'>planner</span><span class='comma'>,</span> <span class='id identifier rubyid_statement'>statement</span><span class='comma'>,</span> <span class='id identifier rubyid_indexes'>indexes</span><span class='comma'>,</span>
                          <span class='id identifier rubyid_update_costs'>update_costs</span><span class='comma'>,</span> <span class='id identifier rubyid_update_plans'>update_plans</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_planner'>planner</span><span class='period'>.</span><span class='id identifier rubyid_find_plans_for_update'>find_plans_for_update</span><span class='lparen'>(</span><span class='id identifier rubyid_statement'>statement</span><span class='comma'>,</span> <span class='id identifier rubyid_indexes'>indexes</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_plan'>plan</span><span class='op'>|</span>
    <span class='id identifier rubyid_weight'>weight</span> <span class='op'>=</span> <span class='ivar'>@workload</span><span class='period'>.</span><span class='id identifier rubyid_statement_weights'>statement_weights</span><span class='lbracket'>[</span><span class='id identifier rubyid_statement'>statement</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_update_costs'>update_costs</span><span class='lbracket'>[</span><span class='id identifier rubyid_statement'>statement</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='id identifier rubyid_plan'>plan</span><span class='period'>.</span><span class='id identifier rubyid_index'>index</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_plan'>plan</span><span class='period'>.</span><span class='id identifier rubyid_update_cost'>update_cost</span> <span class='op'>*</span> <span class='id identifier rubyid_weight'>weight</span>
    <span class='id identifier rubyid_update_plans'>update_plans</span><span class='lbracket'>[</span><span class='id identifier rubyid_statement'>statement</span><span class='rbracket'>]</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_plan'>plan</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="query_cost-instance_method">
  
    #<strong>query_cost</strong>(planner, query, weight)  &#x21d2; <tt><span class='object_link'><a href="../../Object.html" title="Object (class)">Object</a></span></tt>  <span class="extras">(private)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Get the cost for indices for an individual query</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/nose/search.rb', line 185</span>

<span class='kw'>def</span> <span class='id identifier rubyid_query_cost'>query_cost</span><span class='lparen'>(</span><span class='id identifier rubyid_planner'>planner</span><span class='comma'>,</span> <span class='id identifier rubyid_query'>query</span><span class='comma'>,</span> <span class='id identifier rubyid_weight'>weight</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_query_costs'>query_costs</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>

  <span class='id identifier rubyid_tree'>tree</span> <span class='op'>=</span> <span class='id identifier rubyid_planner'>planner</span><span class='period'>.</span><span class='id identifier rubyid_find_plans_for_query'>find_plans_for_query</span><span class='lparen'>(</span><span class='id identifier rubyid_query'>query</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_tree'>tree</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_plan'>plan</span><span class='op'>|</span>
    <span class='id identifier rubyid_steps_by_index'>steps_by_index</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_plan'>plan</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_step'>step</span><span class='op'>|</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_step'>step</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span> <span class='const'><span class='object_link'><a href="../Plans.html" title="NoSE::Plans (module)">Plans</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Plans/IndexLookupPlanStep.html" title="NoSE::Plans::IndexLookupPlanStep (class)">IndexLookupPlanStep</a></span></span>
        <span class='id identifier rubyid_steps_by_index'>steps_by_index</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span> <span class='lbracket'>[</span><span class='id identifier rubyid_step'>step</span><span class='rbracket'>]</span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_steps_by_index'>steps_by_index</span><span class='period'>.</span><span class='id identifier rubyid_last'>last</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span> <span class='id identifier rubyid_step'>step</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_populate_query_costs'>populate_query_costs</span> <span class='id identifier rubyid_query_costs'>query_costs</span><span class='comma'>,</span> <span class='id identifier rubyid_steps_by_index'>steps_by_index</span><span class='comma'>,</span> <span class='id identifier rubyid_weight'>weight</span><span class='comma'>,</span> <span class='id identifier rubyid_query'>query</span><span class='comma'>,</span> <span class='id identifier rubyid_tree'>tree</span>
  <span class='kw'>end</span>

  <span class='lbracket'>[</span><span class='id identifier rubyid_query_costs'>query_costs</span><span class='comma'>,</span> <span class='id identifier rubyid_tree'>tree</span><span class='rbracket'>]</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="query_costs-instance_method">
  
    #<strong>query_costs</strong>(query_weights, indexes)  &#x21d2; <tt><span class='object_link'><a href="../../Object.html" title="Object (class)">Object</a></span></tt>  <span class="extras">(private)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Get the cost of using each index for each query in a workload</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


171
172
173
174
175
176
177
178
179
180
181
182</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/nose/search.rb', line 171</span>

<span class='kw'>def</span> <span class='id identifier rubyid_query_costs'>query_costs</span><span class='lparen'>(</span><span class='id identifier rubyid_query_weights'>query_weights</span><span class='comma'>,</span> <span class='id identifier rubyid_indexes'>indexes</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_planner'>planner</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../Plans.html" title="NoSE::Plans (module)">Plans</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Plans/QueryPlanner.html" title="NoSE::Plans::QueryPlanner (class)">QueryPlanner</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../Plans/QueryPlanner.html#initialize-instance_method" title="NoSE::Plans::QueryPlanner#initialize (method)">new</a></span></span> <span class='ivar'>@workload</span><span class='comma'>,</span> <span class='id identifier rubyid_indexes'>indexes</span><span class='comma'>,</span> <span class='ivar'>@cost_model</span>

  <span class='id identifier rubyid_results'>results</span> <span class='op'>=</span> <span class='const'>Parallel</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lparen'>(</span><span class='id identifier rubyid_query_weights'>query_weights</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_query'>query</span><span class='comma'>,</span> <span class='id identifier rubyid_weight'>weight</span><span class='op'>|</span>
    <span class='id identifier rubyid_query_cost'>query_cost</span> <span class='id identifier rubyid_planner'>planner</span><span class='comma'>,</span> <span class='id identifier rubyid_query'>query</span><span class='comma'>,</span> <span class='id identifier rubyid_weight'>weight</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_costs'>costs</span> <span class='op'>=</span> <span class='const'>Hash</span><span class='lbracket'>[</span><span class='id identifier rubyid_query_weights'>query_weights</span><span class='period'>.</span><span class='id identifier rubyid_each_key'>each_key</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='period'>.</span><span class='id identifier rubyid_with_index'>with_index</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_query'>query</span><span class='comma'>,</span> <span class='id identifier rubyid_q'>q</span><span class='op'>|</span>
    <span class='lbracket'>[</span><span class='id identifier rubyid_query'>query</span><span class='comma'>,</span> <span class='id identifier rubyid_results'>results</span><span class='lbracket'>[</span><span class='id identifier rubyid_q'>q</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span><span class='rbracket'>]</span>
  <span class='kw'>end</span><span class='rbracket'>]</span>

  <span class='lbracket'>[</span><span class='id identifier rubyid_costs'>costs</span><span class='comma'>,</span> <span class='id identifier rubyid_results'>results</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:last</span><span class='rparen'>)</span><span class='rbracket'>]</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="search_overlap-instance_method">
  
    #<strong>search_overlap</strong>(indexes, max_space = Float::INFINITY)  &#x21d2; <tt><span class='object_link'><a href="Results.html" title="NoSE::Search::Results (class)">Results</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Search for optimal indices using an ILP which searches for non-overlapping indices</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Results.html" title="NoSE::Search::Results (class)">Results</a></span></tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/nose/search.rb', line 33</span>

<span class='kw'>def</span> <span class='id identifier rubyid_search_overlap'>search_overlap</span><span class='lparen'>(</span><span class='id identifier rubyid_indexes'>indexes</span><span class='comma'>,</span> <span class='id identifier rubyid_max_space'>max_space</span> <span class='op'>=</span> <span class='const'>Float</span><span class='op'>::</span><span class='const'>INFINITY</span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='kw'>if</span> <span class='id identifier rubyid_indexes'>indexes</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>

  <span class='comment'># Get the costs of all queries and updates
</span>  <span class='id identifier rubyid_query_weights'>query_weights</span> <span class='op'>=</span> <span class='id identifier rubyid_combine_query_weights'>combine_query_weights</span> <span class='id identifier rubyid_indexes'>indexes</span>
  <span class='id identifier rubyid_costs'>costs</span><span class='comma'>,</span> <span class='id identifier rubyid_trees'>trees</span> <span class='op'>=</span> <span class='id identifier rubyid_query_costs'>query_costs</span> <span class='id identifier rubyid_query_weights'>query_weights</span><span class='comma'>,</span> <span class='id identifier rubyid_indexes'>indexes</span>
  <span class='id identifier rubyid_update_costs'>update_costs</span><span class='comma'>,</span> <span class='id identifier rubyid_update_plans'>update_plans</span> <span class='op'>=</span> <span class='id identifier rubyid_update_costs'>update_costs</span> <span class='id identifier rubyid_trees'>trees</span><span class='comma'>,</span> <span class='id identifier rubyid_indexes'>indexes</span>

  <span class='id identifier rubyid_log_search_start'>log_search_start</span> <span class='id identifier rubyid_costs'>costs</span><span class='comma'>,</span> <span class='id identifier rubyid_query_weights'>query_weights</span>

  <span class='id identifier rubyid_solver_params'>solver_params</span> <span class='op'>=</span> <span class='lbrace'>{</span>
    <span class='label'>max_space:</span> <span class='id identifier rubyid_max_space'>max_space</span><span class='comma'>,</span>
    <span class='label'>costs:</span> <span class='id identifier rubyid_costs'>costs</span><span class='comma'>,</span>
    <span class='label'>update_costs:</span> <span class='id identifier rubyid_update_costs'>update_costs</span><span class='comma'>,</span>
    <span class='label'>cost_model:</span> <span class='ivar'>@cost_model</span><span class='comma'>,</span>
    <span class='label'>by_id_graph:</span> <span class='ivar'>@by_id_graph</span>
  <span class='rbrace'>}</span>
  <span class='id identifier rubyid_search_result'>search_result</span> <span class='id identifier rubyid_query_weights'>query_weights</span><span class='comma'>,</span> <span class='id identifier rubyid_indexes'>indexes</span><span class='comma'>,</span> <span class='id identifier rubyid_solver_params'>solver_params</span><span class='comma'>,</span> <span class='id identifier rubyid_trees'>trees</span><span class='comma'>,</span>
                <span class='id identifier rubyid_update_plans'>update_plans</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="search_result-instance_method">
  
    #<strong>search_result</strong>(query_weights, indexes, solver_params, trees, update_plans)  &#x21d2; <tt><span class='object_link'><a href="Results.html" title="NoSE::Search::Results (class)">Results</a></span></tt>  <span class="extras">(private)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Run the solver and get the results of search</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Results.html" title="NoSE::Search::Results (class)">Results</a></span></tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/nose/search.rb', line 84</span>

<span class='kw'>def</span> <span class='id identifier rubyid_search_result'>search_result</span><span class='lparen'>(</span><span class='id identifier rubyid_query_weights'>query_weights</span><span class='comma'>,</span> <span class='id identifier rubyid_indexes'>indexes</span><span class='comma'>,</span> <span class='id identifier rubyid_solver_params'>solver_params</span><span class='comma'>,</span> <span class='id identifier rubyid_trees'>trees</span><span class='comma'>,</span>
                  <span class='id identifier rubyid_update_plans'>update_plans</span><span class='rparen'>)</span>
  <span class='comment'># Solve the LP using MIPPeR
</span>  <span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='id identifier rubyid_solve_mipper'>solve_mipper</span> <span class='id identifier rubyid_query_weights'>query_weights</span><span class='period'>.</span><span class='id identifier rubyid_keys'>keys</span><span class='comma'>,</span> <span class='id identifier rubyid_indexes'>indexes</span><span class='comma'>,</span> <span class='op'>**</span><span class='id identifier rubyid_solver_params'>solver_params</span>

  <span class='id identifier rubyid_result'>result</span><span class='period'>.</span><span class='id identifier rubyid_workload'>workload</span> <span class='op'>=</span> <span class='ivar'>@workload</span>
  <span class='id identifier rubyid_result'>result</span><span class='period'>.</span><span class='id identifier rubyid_plans_from_trees'>plans_from_trees</span> <span class='id identifier rubyid_trees'>trees</span>

  <span class='comment'># Select the relevant update plans
</span>  <span class='id identifier rubyid_update_plans'>update_plans</span> <span class='op'>=</span> <span class='id identifier rubyid_update_plans'>update_plans</span><span class='period'>.</span><span class='id identifier rubyid_values'>values</span><span class='period'>.</span><span class='id identifier rubyid_flatten'>flatten</span><span class='lparen'>(</span><span class='int'>1</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_select'>select</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_plan'>plan</span><span class='op'>|</span>
    <span class='id identifier rubyid_result'>result</span><span class='period'>.</span><span class='id identifier rubyid_indexes'>indexes</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span> <span class='id identifier rubyid_plan'>plan</span><span class='period'>.</span><span class='id identifier rubyid_index'>index</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_update_plans'>update_plans</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_plan'>plan</span><span class='op'>|</span>
    <span class='id identifier rubyid_plan'>plan</span><span class='period'>.</span><span class='id identifier rubyid_select_query_plans'>select_query_plans</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='id identifier rubyid_result'>result</span><span class='period'>.</span><span class='id identifier rubyid_method'>method</span><span class='lparen'>(</span><span class='symbol'>:select_plan</span><span class='rparen'>)</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_result'>result</span><span class='period'>.</span><span class='id identifier rubyid_update_plans'>update_plans</span> <span class='op'>=</span> <span class='id identifier rubyid_update_plans'>update_plans</span>

  <span class='id identifier rubyid_result'>result</span><span class='period'>.</span><span class='id identifier rubyid_cost_model'>cost_model</span> <span class='op'>=</span> <span class='ivar'>@cost_model</span>
  <span class='id identifier rubyid_result'>result</span><span class='period'>.</span><span class='id identifier rubyid_validate'>validate</span>

  <span class='id identifier rubyid_result'>result</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="select_plans-instance_method">
  
    #<strong>select_plans</strong>(trees, indexes)  &#x21d2; <tt><span class='object_link'><a href="../../Array.html" title="Array (class)">Array</a></span>&lt;<span class='object_link'><a href="../Plans/QueryPlan.html" title="NoSE::Plans::QueryPlan (class)">Plans::QueryPlan</a></span>&gt;</tt>  <span class="extras">(private)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Select the plans to use for a given set of indexes</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../../Array.html" title="Array (class)">Array</a></span>&lt;<span class='object_link'><a href="../Plans/QueryPlan.html" title="NoSE::Plans::QueryPlan (class)">Plans::QueryPlan</a></span>&gt;</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


109
110
111
112
113
114
115
116
117
118</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/nose/search.rb', line 109</span>

<span class='kw'>def</span> <span class='id identifier rubyid_select_plans'>select_plans</span><span class='lparen'>(</span><span class='id identifier rubyid_trees'>trees</span><span class='comma'>,</span> <span class='id identifier rubyid_indexes'>indexes</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_trees'>trees</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_tree'>tree</span><span class='op'>|</span>
    <span class='comment'># Exclude support queries since they will be in update plans
</span>    <span class='id identifier rubyid_query'>query</span> <span class='op'>=</span> <span class='id identifier rubyid_tree'>tree</span><span class='period'>.</span><span class='id identifier rubyid_query'>query</span>
    <span class='kw'>next</span> <span class='kw'>if</span> <span class='id identifier rubyid_query'>query</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="../SupportQuery.html" title="NoSE::SupportQuery (class)">SupportQuery</a></span></span><span class='rparen'>)</span>

    <span class='comment'># Select the exact plan to use for these indexes
</span>    <span class='id identifier rubyid_tree'>tree</span><span class='period'>.</span><span class='id identifier rubyid_select_using_indexes'>select_using_indexes</span><span class='lparen'>(</span><span class='id identifier rubyid_indexes'>indexes</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_min_by'>min_by</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:cost</span><span class='rparen'>)</span>
  <span class='kw'>end</span><span class='period'>.</span><span class='id identifier rubyid_compact'>compact</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="solve_mipper-instance_method">
  
    #<strong>solve_mipper</strong>(queries, indexes, data)  &#x21d2; <tt><span class='object_link'><a href="Results.html" title="NoSE::Search::Results (class)">Results</a></span></tt>  <span class="extras">(private)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Solve the index selection problem using MIPPeR</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Results.html" title="NoSE::Search::Results (class)">Results</a></span></tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/nose/search.rb', line 122</span>

<span class='kw'>def</span> <span class='id identifier rubyid_solve_mipper'>solve_mipper</span><span class='lparen'>(</span><span class='id identifier rubyid_queries'>queries</span><span class='comma'>,</span> <span class='id identifier rubyid_indexes'>indexes</span><span class='comma'>,</span> <span class='id identifier rubyid_data'>data</span><span class='rparen'>)</span>
  <span class='comment'># Construct and solve the ILP
</span>  <span class='id identifier rubyid_problem'>problem</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Problem.html" title="NoSE::Search::Problem (class)">Problem</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Problem.html#initialize-instance_method" title="NoSE::Search::Problem#initialize (method)">new</a></span></span> <span class='id identifier rubyid_queries'>queries</span><span class='comma'>,</span> <span class='ivar'>@workload</span><span class='period'>.</span><span class='id identifier rubyid_updates'>updates</span><span class='comma'>,</span> <span class='id identifier rubyid_data'>data</span><span class='comma'>,</span> <span class='ivar'>@objective</span>
  <span class='id identifier rubyid_problem'>problem</span><span class='period'>.</span><span class='id identifier rubyid_solve'>solve</span>

  <span class='comment'># We won&#39;t get here if there&#39;s no valdi solution
</span>  <span class='ivar'>@logger</span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Found solution with total cost </span><span class='tstring_end'>&#39;</span></span> \
                <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_problem'>problem</span><span class='period'>.</span><span class='id identifier rubyid_objective_value'>objective_value</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>

  <span class='comment'># Return the selected indices
</span>  <span class='id identifier rubyid_selected_indexes'>selected_indexes</span> <span class='op'>=</span> <span class='id identifier rubyid_problem'>problem</span><span class='period'>.</span><span class='id identifier rubyid_selected_indexes'>selected_indexes</span>

  <span class='ivar'>@logger</span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span> <span class='kw'>do</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Selected indexes:\n</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='id identifier rubyid_selected_indexes'>selected_indexes</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_index'>index</span><span class='op'>|</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_indexes'>indexes</span><span class='period'>.</span><span class='id identifier rubyid_index'>index</span> <span class='id identifier rubyid_index'>index</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_index'>index</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_problem'>problem</span><span class='period'>.</span><span class='id identifier rubyid_result'>result</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="update_costs-instance_method">
  
    #<strong>update_costs</strong>(trees, indexes)  &#x21d2; <tt><span class='object_link'><a href="../../Object.html" title="Object (class)">Object</a></span></tt>  <span class="extras">(private)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Produce the cost of updates in the workload</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


144
145
146
147
148
149
150
151
152
153
154
155
156
157</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/nose/search.rb', line 144</span>

<span class='kw'>def</span> <span class='id identifier rubyid_update_costs'>update_costs</span><span class='lparen'>(</span><span class='id identifier rubyid_trees'>trees</span><span class='comma'>,</span> <span class='id identifier rubyid_indexes'>indexes</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_planner'>planner</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../Plans.html" title="NoSE::Plans (module)">Plans</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Plans/UpdatePlanner.html" title="NoSE::Plans::UpdatePlanner (class)">UpdatePlanner</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../Plans/UpdatePlanner.html#initialize-instance_method" title="NoSE::Plans::UpdatePlanner#initialize (method)">new</a></span></span> <span class='ivar'>@workload</span><span class='period'>.</span><span class='id identifier rubyid_model'>model</span><span class='comma'>,</span> <span class='id identifier rubyid_trees'>trees</span><span class='comma'>,</span> <span class='ivar'>@cost_model</span><span class='comma'>,</span>
                                     <span class='ivar'>@by_id_graph</span>
  <span class='id identifier rubyid_update_costs'>update_costs</span> <span class='op'>=</span> <span class='const'>Hash</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_h'>h</span><span class='comma'>,</span> <span class='id identifier rubyid_k'>k</span><span class='op'>|</span> <span class='id identifier rubyid_h'>h</span><span class='lbracket'>[</span><span class='id identifier rubyid_k'>k</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span> <span class='rbrace'>}</span>
  <span class='id identifier rubyid_update_plans'>update_plans</span> <span class='op'>=</span> <span class='const'>Hash</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_h'>h</span><span class='comma'>,</span> <span class='id identifier rubyid_k'>k</span><span class='op'>|</span> <span class='id identifier rubyid_h'>h</span><span class='lbracket'>[</span><span class='id identifier rubyid_k'>k</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span> <span class='rbrace'>}</span>
  <span class='ivar'>@workload</span><span class='period'>.</span><span class='id identifier rubyid_statements'>statements</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_statement'>statement</span><span class='op'>|</span>
    <span class='kw'>next</span> <span class='kw'>if</span> <span class='id identifier rubyid_statement'>statement</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span> <span class='const'><span class='object_link'><a href="../Query.html" title="NoSE::Query (class)">Query</a></span></span>

    <span class='id identifier rubyid_populate_update_costs'>populate_update_costs</span> <span class='id identifier rubyid_planner'>planner</span><span class='comma'>,</span> <span class='id identifier rubyid_statement'>statement</span><span class='comma'>,</span> <span class='id identifier rubyid_indexes'>indexes</span><span class='comma'>,</span>
                          <span class='id identifier rubyid_update_costs'>update_costs</span><span class='comma'>,</span> <span class='id identifier rubyid_update_plans'>update_plans</span>
  <span class='kw'>end</span>

  <span class='lbracket'>[</span><span class='id identifier rubyid_update_costs'>update_costs</span><span class='comma'>,</span> <span class='id identifier rubyid_update_plans'>update_plans</span><span class='rbracket'>]</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  Generated on Fri Feb 28 13:56:15 2020 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.24 (ruby-2.7.0).
</div>

    </div>
  </body>
</html>