<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Class: NoSE::Plans::UpdatePlanner
  
    &mdash; Documentation by YARD 0.9.25
  
</title>

  <link rel="stylesheet" href="../../css/style.css" type="text/css" />

  <link rel="stylesheet" href="../../css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "NoSE::Plans::UpdatePlanner";
  relpath = '../../';
</script>


  <script type="text/javascript" charset="utf-8" src="../../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../../js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="../../class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="../../_index.html">Index (U)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../../NoSE.html" title="NoSE (module)">NoSE</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../Plans.html" title="NoSE::Plans (module)">Plans</a></span></span>
     &raquo; 
    <span class="title">UpdatePlanner</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../../class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><h1>Class: NoSE::Plans::UpdatePlanner
  
  
  
</h1>
<div class="box_info">
  
  <dl>
    <dt>Inherits:</dt>
    <dd>
      <span class="inheritName"><span class='object_link'><a href="../../Object.html" title="Object (class)">Object</a></span></span>
      
        <ul class="fullTree">
          <li><span class='object_link'><a href="../../Object.html" title="Object (class)">Object</a></span></li>
          
            <li class="next">NoSE::Plans::UpdatePlanner</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
    </dd>
  </dl>
  

  
  
  
  
  

  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>lib/nose/plans/update_planner.rb</dd>
  </dl>
  
</div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>A planner for update statements in the workload</p>


  </div>
</div>
<div class="tags">
  

</div>






  
    <h2>
      Instance Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#find_plans_for_update-instance_method" title="#find_plans_for_update (instance method)">#<strong>find_plans_for_update</strong>(statement, indexes)  &#x21d2; Array&lt;UpdatePlan&gt; </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Find the necessary update plans for a given set of indexes.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#initialize-instance_method" title="#initialize (instance method)">#<strong>initialize</strong>(model, trees, cost_model, by_id_graph = false)  &#x21d2; UpdatePlanner </a>
    

    
  </span>
  
  
    <span class="note title constructor">constructor</span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>A new instance of UpdatePlanner.</p>
</div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#update_steps-instance_method" title="#update_steps (instance method)">#<strong>update_steps</strong>(statement, index, state)  &#x21d2; Array&lt;UpdatePlanStep&gt; </a>
    

    
  </span>
  
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Find the required update steps.</p>
</div></span>
  
</li>

      
    </ul>
  

<div id="constructor_details" class="method_details_list">
  <h2>Constructor Details</h2>
  
    <div class="method_details first">
  <h3 class="signature first" id="initialize-instance_method">
  
    #<strong>initialize</strong>(model, trees, cost_model, by_id_graph = false)  &#x21d2; <tt><span class='object_link'><a href="" title="NoSE::Plans::UpdatePlanner (class)">UpdatePlanner</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns a new instance of UpdatePlanner.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/nose/plans/update_planner.rb', line 188</span>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='id identifier rubyid_model'>model</span><span class='comma'>,</span> <span class='id identifier rubyid_trees'>trees</span><span class='comma'>,</span> <span class='id identifier rubyid_cost_model'>cost_model</span><span class='comma'>,</span> <span class='id identifier rubyid_by_id_graph'>by_id_graph</span> <span class='op'>=</span> <span class='kw'>false</span><span class='rparen'>)</span>
  <span class='ivar'>@logger</span> <span class='op'>=</span> <span class='const'>Logging</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>nose::update_planner</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>

  <span class='ivar'>@model</span> <span class='op'>=</span> <span class='id identifier rubyid_model'>model</span>
  <span class='ivar'>@cost_model</span> <span class='op'>=</span> <span class='id identifier rubyid_cost_model'>cost_model</span>
  <span class='ivar'>@by_id_graph</span> <span class='op'>=</span> <span class='id identifier rubyid_by_id_graph'>by_id_graph</span>

  <span class='comment'># Remove anything not a support query then group by statement and index
</span>  <span class='ivar'>@query_plans</span> <span class='op'>=</span> <span class='id identifier rubyid_trees'>trees</span><span class='period'>.</span><span class='id identifier rubyid_select'>select</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_tree'>tree</span><span class='op'>|</span>
    <span class='id identifier rubyid_tree'>tree</span><span class='period'>.</span><span class='id identifier rubyid_query'>query</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span> <span class='const'><span class='object_link'><a href="../SupportQuery.html" title="NoSE::SupportQuery (class)">SupportQuery</a></span></span>
  <span class='kw'>end</span>
  <span class='ivar'>@query_plans</span> <span class='op'>=</span> <span class='ivar'>@query_plans</span><span class='period'>.</span><span class='id identifier rubyid_group_by'>group_by</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_tree'>tree</span><span class='op'>|</span> <span class='id identifier rubyid_tree'>tree</span><span class='period'>.</span><span class='id identifier rubyid_query'>query</span><span class='period'>.</span><span class='id identifier rubyid_statement'>statement</span> <span class='rbrace'>}</span>
  <span class='ivar'>@query_plans</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_plan_stmt'>plan_stmt</span><span class='comma'>,</span> <span class='id identifier rubyid_plan_trees'>plan_trees</span><span class='op'>|</span>
    <span class='ivar'>@query_plans</span><span class='lbracket'>[</span><span class='id identifier rubyid_plan_stmt'>plan_stmt</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_plan_trees'>plan_trees</span><span class='period'>.</span><span class='id identifier rubyid_group_by'>group_by</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_tree'>tree</span><span class='op'>|</span>
      <span class='id identifier rubyid_index'>index</span> <span class='op'>=</span> <span class='id identifier rubyid_tree'>tree</span><span class='period'>.</span><span class='id identifier rubyid_query'>query</span><span class='period'>.</span><span class='id identifier rubyid_index'>index</span>
      <span class='id identifier rubyid_index'>index</span> <span class='op'>=</span> <span class='id identifier rubyid_index'>index</span><span class='period'>.</span><span class='id identifier rubyid_to_id_path'>to_id_path</span> <span class='kw'>if</span> <span class='ivar'>@by_id_path</span>

      <span class='id identifier rubyid_index'>index</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
  
</div>


  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="find_plans_for_update-instance_method">
  
    #<strong>find_plans_for_update</strong>(statement, indexes)  &#x21d2; <tt><span class='object_link'><a href="../../Array.html" title="Array (class)">Array</a></span>&lt;<span class='object_link'><a href="UpdatePlan.html" title="NoSE::Plans::UpdatePlan (class)">UpdatePlan</a></span>&gt;</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Find the necessary update plans for a given set of indexes</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../../Array.html" title="Array (class)">Array</a></span>&lt;<span class='object_link'><a href="UpdatePlan.html" title="NoSE::Plans::UpdatePlan (class)">UpdatePlan</a></span>&gt;</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/nose/plans/update_planner.rb', line 212</span>

<span class='kw'>def</span> <span class='id identifier rubyid_find_plans_for_update'>find_plans_for_update</span><span class='lparen'>(</span><span class='id identifier rubyid_statement'>statement</span><span class='comma'>,</span> <span class='id identifier rubyid_indexes'>indexes</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_indexes'>indexes</span> <span class='op'>=</span> <span class='id identifier rubyid_indexes'>indexes</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:to_id_graph</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_set'>to_set</span> <span class='kw'>if</span> <span class='ivar'>@by_id_graph</span>

  <span class='id identifier rubyid_indexes'>indexes</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_index'>index</span><span class='op'>|</span>
    <span class='kw'>next</span> <span class='kw'>unless</span> <span class='id identifier rubyid_statement'>statement</span><span class='period'>.</span><span class='id identifier rubyid_modifies_index?'>modifies_index?</span><span class='lparen'>(</span><span class='id identifier rubyid_index'>index</span><span class='rparen'>)</span>

    <span class='kw'>if</span> <span class='lparen'>(</span><span class='ivar'>@query_plans</span><span class='lbracket'>[</span><span class='id identifier rubyid_statement'>statement</span><span class='rbracket'>]</span> <span class='op'>&amp;&amp;</span>
        <span class='ivar'>@query_plans</span><span class='lbracket'>[</span><span class='id identifier rubyid_statement'>statement</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='id identifier rubyid_index'>index</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
      <span class='id identifier rubyid_trees'>trees</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>

      <span class='kw'>if</span> <span class='id identifier rubyid_statement'>statement</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span> <span class='const'><span class='object_link'><a href="../Insert.html" title="NoSE::Insert (class)">Insert</a></span></span>
        <span class='id identifier rubyid_cardinality'>cardinality</span> <span class='op'>=</span> <span class='int'>1</span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_cardinality'>cardinality</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Cardinality.html" title="Cardinality (class)">Cardinality</a></span></span><span class='period'>.</span><span class='id identifier rubyid_filter'><span class='object_link'><a href="../../Cardinality.html#filter-class_method" title="Cardinality.filter (method)">filter</a></span></span> <span class='id identifier rubyid_index'>index</span><span class='period'>.</span><span class='id identifier rubyid_entries'>entries</span><span class='comma'>,</span>
                                         <span class='id identifier rubyid_statement'>statement</span><span class='period'>.</span><span class='id identifier rubyid_eq_fields'>eq_fields</span><span class='comma'>,</span>
                                         <span class='id identifier rubyid_statement'>statement</span><span class='period'>.</span><span class='id identifier rubyid_range_field'>range_field</span>
      <span class='kw'>end</span>
    <span class='kw'>else</span>
      <span class='comment'># Get the cardinality of the last step to use for the update state
</span>      <span class='id identifier rubyid_trees'>trees</span> <span class='op'>=</span> <span class='ivar'>@query_plans</span><span class='lbracket'>[</span><span class='id identifier rubyid_statement'>statement</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='id identifier rubyid_index'>index</span><span class='rbracket'>]</span>
      <span class='id identifier rubyid_plans'>plans</span> <span class='op'>=</span> <span class='id identifier rubyid_trees'>trees</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_tree'>tree</span><span class='op'>|</span>
        <span class='id identifier rubyid_tree'>tree</span><span class='period'>.</span><span class='id identifier rubyid_select_using_indexes'>select_using_indexes</span><span class='lparen'>(</span><span class='id identifier rubyid_indexes'>indexes</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_min_by'>min_by</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:cost</span><span class='rparen'>)</span>
      <span class='kw'>end</span>

      <span class='comment'># Multiply the cardinalities because we are crossing multiple
</span>      <span class='comment'># relationships and need the cross-product
</span>      <span class='id identifier rubyid_cardinality'>cardinality</span> <span class='op'>=</span> <span class='id identifier rubyid_plans'>plans</span><span class='period'>.</span><span class='id identifier rubyid_product_by'>product_by</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_p'>p</span><span class='op'>|</span> <span class='id identifier rubyid_p'>p</span><span class='period'>.</span><span class='id identifier rubyid_last'>last</span><span class='period'>.</span><span class='id identifier rubyid_state'>state</span><span class='period'>.</span><span class='id identifier rubyid_cardinality'>cardinality</span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_state'>state</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="UpdateState.html" title="NoSE::Plans::UpdateState (class)">UpdateState</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="UpdateState.html#initialize-instance_method" title="NoSE::Plans::UpdateState#initialize (method)">new</a></span></span> <span class='id identifier rubyid_statement'>statement</span><span class='comma'>,</span> <span class='id identifier rubyid_cardinality'>cardinality</span>
    <span class='id identifier rubyid_update_steps'>update_steps</span> <span class='op'>=</span> <span class='id identifier rubyid_update_steps'>update_steps</span> <span class='id identifier rubyid_statement'>statement</span><span class='comma'>,</span> <span class='id identifier rubyid_index'>index</span><span class='comma'>,</span> <span class='id identifier rubyid_state'>state</span>
    <span class='const'><span class='object_link'><a href="UpdatePlan.html" title="NoSE::Plans::UpdatePlan (class)">UpdatePlan</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="UpdatePlan.html#initialize-instance_method" title="NoSE::Plans::UpdatePlan#initialize (method)">new</a></span></span> <span class='id identifier rubyid_statement'>statement</span><span class='comma'>,</span> <span class='id identifier rubyid_index'>index</span><span class='comma'>,</span> <span class='id identifier rubyid_trees'>trees</span><span class='comma'>,</span> <span class='id identifier rubyid_update_steps'>update_steps</span><span class='comma'>,</span> <span class='ivar'>@cost_model</span>
  <span class='kw'>end</span><span class='period'>.</span><span class='id identifier rubyid_compact'>compact</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="update_steps-instance_method">
  
    #<strong>update_steps</strong>(statement, index, state)  &#x21d2; <tt><span class='object_link'><a href="../../Array.html" title="Array (class)">Array</a></span>&lt;<span class='object_link'><a href="UpdatePlanStep.html" title="NoSE::Plans::UpdatePlanStep (class)">UpdatePlanStep</a></span>&gt;</tt>  <span class="extras">(private)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Find the required update steps</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../../Array.html" title="Array (class)">Array</a></span>&lt;<span class='object_link'><a href="UpdatePlanStep.html" title="NoSE::Plans::UpdatePlanStep (class)">UpdatePlanStep</a></span>&gt;</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/nose/plans/update_planner.rb', line 251</span>

<span class='kw'>def</span> <span class='id identifier rubyid_update_steps'>update_steps</span><span class='lparen'>(</span><span class='id identifier rubyid_statement'>statement</span><span class='comma'>,</span> <span class='id identifier rubyid_index'>index</span><span class='comma'>,</span> <span class='id identifier rubyid_state'>state</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_update_steps'>update_steps</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_update_steps'>update_steps</span> <span class='op'>&lt;&lt;</span> <span class='const'><span class='object_link'><a href="DeletePlanStep.html" title="NoSE::Plans::DeletePlanStep (class)">DeletePlanStep</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="DeletePlanStep.html#initialize-instance_method" title="NoSE::Plans::DeletePlanStep#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_index'>index</span><span class='comma'>,</span> <span class='id identifier rubyid_state'>state</span><span class='rparen'>)</span> \
    <span class='kw'>if</span> <span class='id identifier rubyid_statement'>statement</span><span class='period'>.</span><span class='id identifier rubyid_requires_delete?'>requires_delete?</span><span class='lparen'>(</span><span class='id identifier rubyid_index'>index</span><span class='rparen'>)</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_statement'>statement</span><span class='period'>.</span><span class='id identifier rubyid_requires_insert?'>requires_insert?</span><span class='lparen'>(</span><span class='id identifier rubyid_index'>index</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_fields'>fields</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='id identifier rubyid_statement'>statement</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="../Connect.html" title="NoSE::Connect (class)">Connect</a></span></span><span class='rparen'>)</span>
               <span class='id identifier rubyid_statement'>statement</span><span class='period'>.</span><span class='id identifier rubyid_conditions'>conditions</span><span class='period'>.</span><span class='id identifier rubyid_each_value'>each_value</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:field</span><span class='rparen'>)</span>
             <span class='kw'>else</span>
               <span class='id identifier rubyid_statement'>statement</span><span class='period'>.</span><span class='id identifier rubyid_settings'>settings</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:field</span><span class='rparen'>)</span>
             <span class='kw'>end</span>

    <span class='id identifier rubyid_update_steps'>update_steps</span> <span class='op'>&lt;&lt;</span> <span class='const'><span class='object_link'><a href="InsertPlanStep.html" title="NoSE::Plans::InsertPlanStep (class)">InsertPlanStep</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="InsertPlanStep.html#initialize-instance_method" title="NoSE::Plans::InsertPlanStep#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_index'>index</span><span class='comma'>,</span> <span class='id identifier rubyid_state'>state</span><span class='comma'>,</span> <span class='id identifier rubyid_fields'>fields</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_update_steps'>update_steps</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  Generated on Thu Jul 16 13:49:02 2020 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.25 (ruby-2.7.0).
</div>

    </div>
  </body>
</html>